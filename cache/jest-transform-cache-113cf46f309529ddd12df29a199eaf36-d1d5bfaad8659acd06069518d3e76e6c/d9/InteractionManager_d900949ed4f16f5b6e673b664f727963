c3548f52655415ee40765ea557c4ab0d
var _interopRequireDefault = require("@babel/runtime/helpers/interopRequireDefault");

var _EventEmitter = _interopRequireDefault(require("../vendor/emitter/EventEmitter"));

var BatchedBridge = require('../BatchedBridge/BatchedBridge');

var TaskQueue = require('./TaskQueue');

var infoLog = require('../Utilities/infoLog');

var invariant = require('invariant');

var _emitter = new _EventEmitter.default();

var DEBUG_DELAY = 0;
var DEBUG = false;
var InteractionManager = {
  Events: {
    interactionStart: 'interactionStart',
    interactionComplete: 'interactionComplete'
  },
  runAfterInteractions: function runAfterInteractions(task) {
    var tasks = [];
    var promise = new Promise(function (resolve) {
      _scheduleUpdate();

      if (task) {
        tasks.push(task);
      }

      tasks.push({
        run: resolve,
        name: 'resolve ' + (task && task.name || '?')
      });

      _taskQueue.enqueueTasks(tasks);
    });
    return {
      then: promise.then.bind(promise),
      done: function done() {
        if (promise.done) {
          return promise.done.apply(promise, arguments);
        } else {
          console.warn('Tried to call done when not supported by current Promise implementation.');
        }
      },
      cancel: function cancel() {
        _taskQueue.cancelTasks(tasks);
      }
    };
  },
  createInteractionHandle: function createInteractionHandle() {
    DEBUG && infoLog('InteractionManager: create interaction handle');

    _scheduleUpdate();

    var handle = ++_inc;

    _addInteractionSet.add(handle);

    return handle;
  },
  clearInteractionHandle: function clearInteractionHandle(handle) {
    DEBUG && infoLog('InteractionManager: clear interaction handle');
    invariant(!!handle, 'InteractionManager: Must provide a handle to clear.');

    _scheduleUpdate();

    _addInteractionSet.delete(handle);

    _deleteInteractionSet.add(handle);
  },
  addListener: _emitter.addListener.bind(_emitter),
  setDeadline: function setDeadline(deadline) {
    _deadline = deadline;
  }
};

var _interactionSet = new Set();

var _addInteractionSet = new Set();

var _deleteInteractionSet = new Set();

var _taskQueue = new TaskQueue({
  onMoreTasks: _scheduleUpdate
});

var _nextUpdateHandle = 0;
var _inc = 0;

var _deadline = -1;

function _scheduleUpdate() {
  if (!_nextUpdateHandle) {
    if (_deadline > 0) {
      _nextUpdateHandle = setTimeout(_processUpdate, 0 + DEBUG_DELAY);
    } else {
      _nextUpdateHandle = setImmediate(_processUpdate);
    }
  }
}

function _processUpdate() {
  _nextUpdateHandle = 0;
  var interactionCount = _interactionSet.size;

  _addInteractionSet.forEach(function (handle) {
    return _interactionSet.add(handle);
  });

  _deleteInteractionSet.forEach(function (handle) {
    return _interactionSet.delete(handle);
  });

  var nextInteractionCount = _interactionSet.size;

  if (interactionCount !== 0 && nextInteractionCount === 0) {
    _emitter.emit(InteractionManager.Events.interactionComplete);
  } else if (interactionCount === 0 && nextInteractionCount !== 0) {
    _emitter.emit(InteractionManager.Events.interactionStart);
  }

  if (nextInteractionCount === 0) {
    while (_taskQueue.hasTasksToProcess()) {
      _taskQueue.processNext();

      if (_deadline > 0 && BatchedBridge.getEventLoopRunningTime() >= _deadline) {
        _scheduleUpdate();

        break;
      }
    }
  }

  _addInteractionSet.clear();

  _deleteInteractionSet.clear();
}

module.exports = InteractionManager;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJuYW1lcyI6WyJCYXRjaGVkQnJpZGdlIiwicmVxdWlyZSIsIlRhc2tRdWV1ZSIsImluZm9Mb2ciLCJpbnZhcmlhbnQiLCJfZW1pdHRlciIsIkV2ZW50RW1pdHRlciIsIkRFQlVHX0RFTEFZIiwiREVCVUciLCJJbnRlcmFjdGlvbk1hbmFnZXIiLCJFdmVudHMiLCJpbnRlcmFjdGlvblN0YXJ0IiwiaW50ZXJhY3Rpb25Db21wbGV0ZSIsInJ1bkFmdGVySW50ZXJhY3Rpb25zIiwidGFzayIsInRhc2tzIiwicHJvbWlzZSIsIlByb21pc2UiLCJyZXNvbHZlIiwiX3NjaGVkdWxlVXBkYXRlIiwicHVzaCIsInJ1biIsIm5hbWUiLCJfdGFza1F1ZXVlIiwiZW5xdWV1ZVRhc2tzIiwidGhlbiIsImJpbmQiLCJkb25lIiwiY29uc29sZSIsIndhcm4iLCJjYW5jZWwiLCJjYW5jZWxUYXNrcyIsImNyZWF0ZUludGVyYWN0aW9uSGFuZGxlIiwiaGFuZGxlIiwiX2luYyIsIl9hZGRJbnRlcmFjdGlvblNldCIsImFkZCIsImNsZWFySW50ZXJhY3Rpb25IYW5kbGUiLCJkZWxldGUiLCJfZGVsZXRlSW50ZXJhY3Rpb25TZXQiLCJhZGRMaXN0ZW5lciIsInNldERlYWRsaW5lIiwiZGVhZGxpbmUiLCJfZGVhZGxpbmUiLCJfaW50ZXJhY3Rpb25TZXQiLCJTZXQiLCJvbk1vcmVUYXNrcyIsIl9uZXh0VXBkYXRlSGFuZGxlIiwic2V0VGltZW91dCIsIl9wcm9jZXNzVXBkYXRlIiwic2V0SW1tZWRpYXRlIiwiaW50ZXJhY3Rpb25Db3VudCIsInNpemUiLCJmb3JFYWNoIiwibmV4dEludGVyYWN0aW9uQ291bnQiLCJlbWl0IiwiaGFzVGFza3NUb1Byb2Nlc3MiLCJwcm9jZXNzTmV4dCIsImdldEV2ZW50TG9vcFJ1bm5pbmdUaW1lIiwiY2xlYXIiLCJtb2R1bGUiLCJleHBvcnRzIl0sInNvdXJjZXMiOlsiSW50ZXJhY3Rpb25NYW5hZ2VyLmpzIl0sInNvdXJjZXNDb250ZW50IjpbIi8qKlxuICogQ29weXJpZ2h0IChjKSBGYWNlYm9vaywgSW5jLiBhbmQgaXRzIGFmZmlsaWF0ZXMuXG4gKlxuICogVGhpcyBzb3VyY2UgY29kZSBpcyBsaWNlbnNlZCB1bmRlciB0aGUgTUlUIGxpY2Vuc2UgZm91bmQgaW4gdGhlXG4gKiBMSUNFTlNFIGZpbGUgaW4gdGhlIHJvb3QgZGlyZWN0b3J5IG9mIHRoaXMgc291cmNlIHRyZWUuXG4gKlxuICogQGZvcm1hdFxuICogQGZsb3cgc3RyaWN0LWxvY2FsXG4gKi9cblxuY29uc3QgQmF0Y2hlZEJyaWRnZSA9IHJlcXVpcmUoJy4uL0JhdGNoZWRCcmlkZ2UvQmF0Y2hlZEJyaWRnZScpO1xuY29uc3QgVGFza1F1ZXVlID0gcmVxdWlyZSgnLi9UYXNrUXVldWUnKTtcblxuY29uc3QgaW5mb0xvZyA9IHJlcXVpcmUoJy4uL1V0aWxpdGllcy9pbmZvTG9nJyk7XG5jb25zdCBpbnZhcmlhbnQgPSByZXF1aXJlKCdpbnZhcmlhbnQnKTtcblxuaW1wb3J0IEV2ZW50RW1pdHRlciBmcm9tICcuLi92ZW5kb3IvZW1pdHRlci9FdmVudEVtaXR0ZXInO1xuXG5leHBvcnQgdHlwZSBIYW5kbGUgPSBudW1iZXI7XG5pbXBvcnQgdHlwZSB7VGFza30gZnJvbSAnLi9UYXNrUXVldWUnO1xuXG5jb25zdCBfZW1pdHRlciA9IG5ldyBFdmVudEVtaXR0ZXI8e1xuICBpbnRlcmFjdGlvbkNvbXBsZXRlOiBbXSxcbiAgaW50ZXJhY3Rpb25TdGFydDogW10sXG59PigpO1xuXG5jb25zdCBERUJVR19ERUxBWTogMCA9IDA7XG5jb25zdCBERUJVRzogZmFsc2UgPSBmYWxzZTtcblxuLyoqXG4gKiBJbnRlcmFjdGlvbk1hbmFnZXIgYWxsb3dzIGxvbmctcnVubmluZyB3b3JrIHRvIGJlIHNjaGVkdWxlZCBhZnRlciBhbnlcbiAqIGludGVyYWN0aW9ucy9hbmltYXRpb25zIGhhdmUgY29tcGxldGVkLiBJbiBwYXJ0aWN1bGFyLCB0aGlzIGFsbG93cyBKYXZhU2NyaXB0XG4gKiBhbmltYXRpb25zIHRvIHJ1biBzbW9vdGhseS5cbiAqXG4gKiBBcHBsaWNhdGlvbnMgY2FuIHNjaGVkdWxlIHRhc2tzIHRvIHJ1biBhZnRlciBpbnRlcmFjdGlvbnMgd2l0aCB0aGUgZm9sbG93aW5nOlxuICpcbiAqIGBgYFxuICogSW50ZXJhY3Rpb25NYW5hZ2VyLnJ1bkFmdGVySW50ZXJhY3Rpb25zKCgpID0+IHtcbiAqICAgLy8gLi4ubG9uZy1ydW5uaW5nIHN5bmNocm9ub3VzIHRhc2suLi5cbiAqIH0pO1xuICogYGBgXG4gKlxuICogQ29tcGFyZSB0aGlzIHRvIG90aGVyIHNjaGVkdWxpbmcgYWx0ZXJuYXRpdmVzOlxuICpcbiAqIC0gcmVxdWVzdEFuaW1hdGlvbkZyYW1lKCk6IGZvciBjb2RlIHRoYXQgYW5pbWF0ZXMgYSB2aWV3IG92ZXIgdGltZS5cbiAqIC0gc2V0SW1tZWRpYXRlL3NldFRpbWVvdXQoKTogcnVuIGNvZGUgbGF0ZXIsIG5vdGUgdGhpcyBtYXkgZGVsYXkgYW5pbWF0aW9ucy5cbiAqIC0gcnVuQWZ0ZXJJbnRlcmFjdGlvbnMoKTogcnVuIGNvZGUgbGF0ZXIsIHdpdGhvdXQgZGVsYXlpbmcgYWN0aXZlIGFuaW1hdGlvbnMuXG4gKlxuICogVGhlIHRvdWNoIGhhbmRsaW5nIHN5c3RlbSBjb25zaWRlcnMgb25lIG9yIG1vcmUgYWN0aXZlIHRvdWNoZXMgdG8gYmUgYW5cbiAqICdpbnRlcmFjdGlvbicgYW5kIHdpbGwgZGVsYXkgYHJ1bkFmdGVySW50ZXJhY3Rpb25zKClgIGNhbGxiYWNrcyB1bnRpbCBhbGxcbiAqIHRvdWNoZXMgaGF2ZSBlbmRlZCBvciBiZWVuIGNhbmNlbGxlZC5cbiAqXG4gKiBJbnRlcmFjdGlvbk1hbmFnZXIgYWxzbyBhbGxvd3MgYXBwbGljYXRpb25zIHRvIHJlZ2lzdGVyIGFuaW1hdGlvbnMgYnlcbiAqIGNyZWF0aW5nIGFuIGludGVyYWN0aW9uICdoYW5kbGUnIG9uIGFuaW1hdGlvbiBzdGFydCwgYW5kIGNsZWFyaW5nIGl0IHVwb25cbiAqIGNvbXBsZXRpb246XG4gKlxuICogYGBgXG4gKiB2YXIgaGFuZGxlID0gSW50ZXJhY3Rpb25NYW5hZ2VyLmNyZWF0ZUludGVyYWN0aW9uSGFuZGxlKCk7XG4gKiAvLyBydW4gYW5pbWF0aW9uLi4uIChgcnVuQWZ0ZXJJbnRlcmFjdGlvbnNgIHRhc2tzIGFyZSBxdWV1ZWQpXG4gKiAvLyBsYXRlciwgb24gYW5pbWF0aW9uIGNvbXBsZXRpb246XG4gKiBJbnRlcmFjdGlvbk1hbmFnZXIuY2xlYXJJbnRlcmFjdGlvbkhhbmRsZShoYW5kbGUpO1xuICogLy8gcXVldWVkIHRhc2tzIHJ1biBpZiBhbGwgaGFuZGxlcyB3ZXJlIGNsZWFyZWRcbiAqIGBgYFxuICpcbiAqIGBydW5BZnRlckludGVyYWN0aW9uc2AgdGFrZXMgZWl0aGVyIGEgcGxhaW4gY2FsbGJhY2sgZnVuY3Rpb24sIG9yIGFcbiAqIGBQcm9taXNlVGFza2Agb2JqZWN0IHdpdGggYSBgZ2VuYCBtZXRob2QgdGhhdCByZXR1cm5zIGEgYFByb21pc2VgLiAgSWYgYVxuICogYFByb21pc2VUYXNrYCBpcyBzdXBwbGllZCwgdGhlbiBpdCBpcyBmdWxseSByZXNvbHZlZCAoaW5jbHVkaW5nIGFzeW5jaHJvbm91c1xuICogZGVwZW5kZW5jaWVzIHRoYXQgYWxzbyBzY2hlZHVsZSBtb3JlIHRhc2tzIHZpYSBgcnVuQWZ0ZXJJbnRlcmFjdGlvbnNgKSBiZWZvcmVcbiAqIHN0YXJ0aW5nIG9uIHRoZSBuZXh0IHRhc2sgdGhhdCBtaWdodCBoYXZlIGJlZW4gcXVldWVkIHVwIHN5bmNocm9ub3VzbHlcbiAqIGVhcmxpZXIuXG4gKlxuICogQnkgZGVmYXVsdCwgcXVldWVkIHRhc2tzIGFyZSBleGVjdXRlZCB0b2dldGhlciBpbiBhIGxvb3AgaW4gb25lXG4gKiBgc2V0SW1tZWRpYXRlYCBiYXRjaC4gSWYgYHNldERlYWRsaW5lYCBpcyBjYWxsZWQgd2l0aCBhIHBvc2l0aXZlIG51bWJlciwgdGhlblxuICogdGFza3Mgd2lsbCBvbmx5IGJlIGV4ZWN1dGVkIHVudGlsIHRoZSBkZWFkbGluZSAoaW4gdGVybXMgb2YganMgZXZlbnQgbG9vcCBydW5cbiAqIHRpbWUpIGFwcHJvYWNoZXMsIGF0IHdoaWNoIHBvaW50IGV4ZWN1dGlvbiB3aWxsIHlpZWxkIHZpYSBzZXRUaW1lb3V0LFxuICogYWxsb3dpbmcgZXZlbnRzIHN1Y2ggYXMgdG91Y2hlcyB0byBzdGFydCBpbnRlcmFjdGlvbnMgYW5kIGJsb2NrIHF1ZXVlZCB0YXNrc1xuICogZnJvbSBleGVjdXRpbmcsIG1ha2luZyBhcHBzIG1vcmUgcmVzcG9uc2l2ZS5cbiAqL1xuY29uc3QgSW50ZXJhY3Rpb25NYW5hZ2VyID0ge1xuICBFdmVudHM6IHtcbiAgICBpbnRlcmFjdGlvblN0YXJ0OiAnaW50ZXJhY3Rpb25TdGFydCcsXG4gICAgaW50ZXJhY3Rpb25Db21wbGV0ZTogJ2ludGVyYWN0aW9uQ29tcGxldGUnLFxuICB9LFxuXG4gIC8qKlxuICAgKiBTY2hlZHVsZSBhIGZ1bmN0aW9uIHRvIHJ1biBhZnRlciBhbGwgaW50ZXJhY3Rpb25zIGhhdmUgY29tcGxldGVkLiBSZXR1cm5zIGEgY2FuY2VsbGFibGVcbiAgICogXCJwcm9taXNlXCIuXG4gICAqL1xuICBydW5BZnRlckludGVyYWN0aW9ucyhcbiAgICB0YXNrOiA/VGFzayxcbiAgKToge1xuICAgIHRoZW46IDxVPihcbiAgICAgIG9uRnVsZmlsbD86ID8odm9pZCkgPT4gPyhQcm9taXNlPFU+IHwgVSksXG4gICAgICBvblJlamVjdD86ID8oZXJyb3I6IG1peGVkKSA9PiA/KFByb21pc2U8VT4gfCBVKSxcbiAgICApID0+IFByb21pc2U8VT4sXG4gICAgZG9uZTogKCkgPT4gdm9pZCxcbiAgICBjYW5jZWw6ICgpID0+IHZvaWQsXG4gICAgLi4uXG4gIH0ge1xuICAgIGNvbnN0IHRhc2tzOiBBcnJheTxUYXNrPiA9IFtdO1xuICAgIGNvbnN0IHByb21pc2UgPSBuZXcgUHJvbWlzZSgocmVzb2x2ZTogKCkgPT4gdm9pZCkgPT4ge1xuICAgICAgX3NjaGVkdWxlVXBkYXRlKCk7XG4gICAgICBpZiAodGFzaykge1xuICAgICAgICB0YXNrcy5wdXNoKHRhc2spO1xuICAgICAgfVxuICAgICAgdGFza3MucHVzaCh7XG4gICAgICAgIHJ1bjogcmVzb2x2ZSxcbiAgICAgICAgbmFtZTogJ3Jlc29sdmUgJyArICgodGFzayAmJiB0YXNrLm5hbWUpIHx8ICc/JyksXG4gICAgICB9KTtcbiAgICAgIF90YXNrUXVldWUuZW5xdWV1ZVRhc2tzKHRhc2tzKTtcbiAgICB9KTtcbiAgICByZXR1cm4ge1xuICAgICAgLy8gJEZsb3dGaXhNZVttZXRob2QtdW5iaW5kaW5nXSBhZGRlZCB3aGVuIGltcHJvdmluZyB0eXBpbmcgZm9yIHRoaXMgcGFyYW1ldGVyc1xuICAgICAgdGhlbjogcHJvbWlzZS50aGVuLmJpbmQocHJvbWlzZSksXG4gICAgICBkb25lOiAoLi4uYXJncykgPT4ge1xuICAgICAgICAvLyAkRmxvd0ZpeE1lW21ldGhvZC11bmJpbmRpbmddIGFkZGVkIHdoZW4gaW1wcm92aW5nIHR5cGluZyBmb3IgdGhpcyBwYXJhbWV0ZXJzXG4gICAgICAgIGlmIChwcm9taXNlLmRvbmUpIHtcbiAgICAgICAgICByZXR1cm4gcHJvbWlzZS5kb25lKC4uLmFyZ3MpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIGNvbnNvbGUud2FybihcbiAgICAgICAgICAgICdUcmllZCB0byBjYWxsIGRvbmUgd2hlbiBub3Qgc3VwcG9ydGVkIGJ5IGN1cnJlbnQgUHJvbWlzZSBpbXBsZW1lbnRhdGlvbi4nLFxuICAgICAgICAgICk7XG4gICAgICAgIH1cbiAgICAgIH0sXG4gICAgICBjYW5jZWw6IGZ1bmN0aW9uKCkge1xuICAgICAgICBfdGFza1F1ZXVlLmNhbmNlbFRhc2tzKHRhc2tzKTtcbiAgICAgIH0sXG4gICAgfTtcbiAgfSxcblxuICAvKipcbiAgICogTm90aWZ5IG1hbmFnZXIgdGhhdCBhbiBpbnRlcmFjdGlvbiBoYXMgc3RhcnRlZC5cbiAgICovXG4gIGNyZWF0ZUludGVyYWN0aW9uSGFuZGxlKCk6IEhhbmRsZSB7XG4gICAgREVCVUcgJiYgaW5mb0xvZygnSW50ZXJhY3Rpb25NYW5hZ2VyOiBjcmVhdGUgaW50ZXJhY3Rpb24gaGFuZGxlJyk7XG4gICAgX3NjaGVkdWxlVXBkYXRlKCk7XG4gICAgY29uc3QgaGFuZGxlID0gKytfaW5jO1xuICAgIF9hZGRJbnRlcmFjdGlvblNldC5hZGQoaGFuZGxlKTtcbiAgICByZXR1cm4gaGFuZGxlO1xuICB9LFxuXG4gIC8qKlxuICAgKiBOb3RpZnkgbWFuYWdlciB0aGF0IGFuIGludGVyYWN0aW9uIGhhcyBjb21wbGV0ZWQuXG4gICAqL1xuICBjbGVhckludGVyYWN0aW9uSGFuZGxlKGhhbmRsZTogSGFuZGxlKSB7XG4gICAgREVCVUcgJiYgaW5mb0xvZygnSW50ZXJhY3Rpb25NYW5hZ2VyOiBjbGVhciBpbnRlcmFjdGlvbiBoYW5kbGUnKTtcbiAgICBpbnZhcmlhbnQoISFoYW5kbGUsICdJbnRlcmFjdGlvbk1hbmFnZXI6IE11c3QgcHJvdmlkZSBhIGhhbmRsZSB0byBjbGVhci4nKTtcbiAgICBfc2NoZWR1bGVVcGRhdGUoKTtcbiAgICBfYWRkSW50ZXJhY3Rpb25TZXQuZGVsZXRlKGhhbmRsZSk7XG4gICAgX2RlbGV0ZUludGVyYWN0aW9uU2V0LmFkZChoYW5kbGUpO1xuICB9LFxuXG4gIC8vICRGbG93Rml4TWVbbWV0aG9kLXVuYmluZGluZ10gYWRkZWQgd2hlbiBpbXByb3ZpbmcgdHlwaW5nIGZvciB0aGlzIHBhcmFtZXRlcnNcbiAgYWRkTGlzdGVuZXI6IChfZW1pdHRlci5hZGRMaXN0ZW5lci5iaW5kKF9lbWl0dGVyKTogJEZsb3dGaXhNZSksXG5cbiAgLyoqXG4gICAqIEEgcG9zaXRpdmUgbnVtYmVyIHdpbGwgdXNlIHNldFRpbWVvdXQgdG8gc2NoZWR1bGUgYW55IHRhc2tzIGFmdGVyIHRoZVxuICAgKiBldmVudExvb3BSdW5uaW5nVGltZSBoaXRzIHRoZSBkZWFkbGluZSB2YWx1ZSwgb3RoZXJ3aXNlIGFsbCB0YXNrcyB3aWxsIGJlXG4gICAqIGV4ZWN1dGVkIGluIG9uZSBzZXRJbW1lZGlhdGUgYmF0Y2ggKGRlZmF1bHQpLlxuICAgKi9cbiAgc2V0RGVhZGxpbmUoZGVhZGxpbmU6IG51bWJlcikge1xuICAgIF9kZWFkbGluZSA9IGRlYWRsaW5lO1xuICB9LFxufTtcblxuY29uc3QgX2ludGVyYWN0aW9uU2V0ID0gbmV3IFNldCgpO1xuY29uc3QgX2FkZEludGVyYWN0aW9uU2V0ID0gbmV3IFNldCgpO1xuY29uc3QgX2RlbGV0ZUludGVyYWN0aW9uU2V0ID0gbmV3IFNldCgpO1xuY29uc3QgX3Rhc2tRdWV1ZSA9IG5ldyBUYXNrUXVldWUoe29uTW9yZVRhc2tzOiBfc2NoZWR1bGVVcGRhdGV9KTtcbmxldCBfbmV4dFVwZGF0ZUhhbmRsZSA9IDA7XG5sZXQgX2luYyA9IDA7XG5sZXQgX2RlYWRsaW5lID0gLTE7XG5cbi8qKlxuICogU2NoZWR1bGUgYW4gYXN5bmNocm9ub3VzIHVwZGF0ZSB0byB0aGUgaW50ZXJhY3Rpb24gc3RhdGUuXG4gKi9cbmZ1bmN0aW9uIF9zY2hlZHVsZVVwZGF0ZSgpIHtcbiAgaWYgKCFfbmV4dFVwZGF0ZUhhbmRsZSkge1xuICAgIGlmIChfZGVhZGxpbmUgPiAwKSB7XG4gICAgICBfbmV4dFVwZGF0ZUhhbmRsZSA9IHNldFRpbWVvdXQoX3Byb2Nlc3NVcGRhdGUsIDAgKyBERUJVR19ERUxBWSk7XG4gICAgfSBlbHNlIHtcbiAgICAgIF9uZXh0VXBkYXRlSGFuZGxlID0gc2V0SW1tZWRpYXRlKF9wcm9jZXNzVXBkYXRlKTtcbiAgICB9XG4gIH1cbn1cblxuLyoqXG4gKiBOb3RpZnkgbGlzdGVuZXJzLCBwcm9jZXNzIHF1ZXVlLCBldGNcbiAqL1xuZnVuY3Rpb24gX3Byb2Nlc3NVcGRhdGUoKSB7XG4gIF9uZXh0VXBkYXRlSGFuZGxlID0gMDtcblxuICBjb25zdCBpbnRlcmFjdGlvbkNvdW50ID0gX2ludGVyYWN0aW9uU2V0LnNpemU7XG4gIF9hZGRJbnRlcmFjdGlvblNldC5mb3JFYWNoKGhhbmRsZSA9PiBfaW50ZXJhY3Rpb25TZXQuYWRkKGhhbmRsZSkpO1xuICBfZGVsZXRlSW50ZXJhY3Rpb25TZXQuZm9yRWFjaChoYW5kbGUgPT4gX2ludGVyYWN0aW9uU2V0LmRlbGV0ZShoYW5kbGUpKTtcbiAgY29uc3QgbmV4dEludGVyYWN0aW9uQ291bnQgPSBfaW50ZXJhY3Rpb25TZXQuc2l6ZTtcblxuICBpZiAoaW50ZXJhY3Rpb25Db3VudCAhPT0gMCAmJiBuZXh0SW50ZXJhY3Rpb25Db3VudCA9PT0gMCkge1xuICAgIC8vIHRyYW5zaXRpb24gZnJvbSAxKyAtLT4gMCBpbnRlcmFjdGlvbnNcbiAgICBfZW1pdHRlci5lbWl0KEludGVyYWN0aW9uTWFuYWdlci5FdmVudHMuaW50ZXJhY3Rpb25Db21wbGV0ZSk7XG4gIH0gZWxzZSBpZiAoaW50ZXJhY3Rpb25Db3VudCA9PT0gMCAmJiBuZXh0SW50ZXJhY3Rpb25Db3VudCAhPT0gMCkge1xuICAgIC8vIHRyYW5zaXRpb24gZnJvbSAwIC0tPiAxKyBpbnRlcmFjdGlvbnNcbiAgICBfZW1pdHRlci5lbWl0KEludGVyYWN0aW9uTWFuYWdlci5FdmVudHMuaW50ZXJhY3Rpb25TdGFydCk7XG4gIH1cblxuICAvLyBwcm9jZXNzIHRoZSBxdWV1ZSByZWdhcmRsZXNzIG9mIGEgdHJhbnNpdGlvblxuICBpZiAobmV4dEludGVyYWN0aW9uQ291bnQgPT09IDApIHtcbiAgICB3aGlsZSAoX3Rhc2tRdWV1ZS5oYXNUYXNrc1RvUHJvY2VzcygpKSB7XG4gICAgICBfdGFza1F1ZXVlLnByb2Nlc3NOZXh0KCk7XG4gICAgICBpZiAoXG4gICAgICAgIF9kZWFkbGluZSA+IDAgJiZcbiAgICAgICAgQmF0Y2hlZEJyaWRnZS5nZXRFdmVudExvb3BSdW5uaW5nVGltZSgpID49IF9kZWFkbGluZVxuICAgICAgKSB7XG4gICAgICAgIC8vIEhpdCBkZWFkbGluZSBiZWZvcmUgcHJvY2Vzc2luZyBhbGwgdGFza3MsIHNvIHByb2Nlc3MgbW9yZSBsYXRlci5cbiAgICAgICAgX3NjaGVkdWxlVXBkYXRlKCk7XG4gICAgICAgIGJyZWFrO1xuICAgICAgfVxuICAgIH1cbiAgfVxuICBfYWRkSW50ZXJhY3Rpb25TZXQuY2xlYXIoKTtcbiAgX2RlbGV0ZUludGVyYWN0aW9uU2V0LmNsZWFyKCk7XG59XG5cbm1vZHVsZS5leHBvcnRzID0gSW50ZXJhY3Rpb25NYW5hZ2VyO1xuIl0sIm1hcHBpbmdzIjoiOztBQWdCQTs7QUFOQSxJQUFNQSxhQUFhLEdBQUdDLE9BQU8sQ0FBQyxnQ0FBRCxDQUE3Qjs7QUFDQSxJQUFNQyxTQUFTLEdBQUdELE9BQU8sQ0FBQyxhQUFELENBQXpCOztBQUVBLElBQU1FLE9BQU8sR0FBR0YsT0FBTyxDQUFDLHNCQUFELENBQXZCOztBQUNBLElBQU1HLFNBQVMsR0FBR0gsT0FBTyxDQUFDLFdBQUQsQ0FBekI7O0FBT0EsSUFBTUksUUFBUSxHQUFHLElBQUlDLHFCQUFKLEVBQWpCOztBQUtBLElBQU1DLFdBQWMsR0FBRyxDQUF2QjtBQUNBLElBQU1DLEtBQVksR0FBRyxLQUFyQjtBQW1EQSxJQUFNQyxrQkFBa0IsR0FBRztFQUN6QkMsTUFBTSxFQUFFO0lBQ05DLGdCQUFnQixFQUFFLGtCQURaO0lBRU5DLG1CQUFtQixFQUFFO0VBRmYsQ0FEaUI7RUFVekJDLG9CQVZ5QixnQ0FXdkJDLElBWHVCLEVBb0J2QjtJQUNBLElBQU1DLEtBQWtCLEdBQUcsRUFBM0I7SUFDQSxJQUFNQyxPQUFPLEdBQUcsSUFBSUMsT0FBSixDQUFZLFVBQUNDLE9BQUQsRUFBeUI7TUFDbkRDLGVBQWU7O01BQ2YsSUFBSUwsSUFBSixFQUFVO1FBQ1JDLEtBQUssQ0FBQ0ssSUFBTixDQUFXTixJQUFYO01BQ0Q7O01BQ0RDLEtBQUssQ0FBQ0ssSUFBTixDQUFXO1FBQ1RDLEdBQUcsRUFBRUgsT0FESTtRQUVUSSxJQUFJLEVBQUUsY0FBZVIsSUFBSSxJQUFJQSxJQUFJLENBQUNRLElBQWQsSUFBdUIsR0FBckM7TUFGRyxDQUFYOztNQUlBQyxVQUFVLENBQUNDLFlBQVgsQ0FBd0JULEtBQXhCO0lBQ0QsQ0FWZSxDQUFoQjtJQVdBLE9BQU87TUFFTFUsSUFBSSxF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